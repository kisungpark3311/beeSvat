// prisma/schema.prisma (프로젝트 루트)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// FEAT-0: User
model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String?   @map("password_hash")
  nickname     String
  profileImage String?   @map("profile_image")
  role         String    @default("user")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  deletedAt    DateTime? @map("deleted_at")

  authTokens  AuthToken[]
  analyses    Analysis[]
  meditations Meditation[]
  reviews     Review[]

  @@index([role])
  @@map("users")
}

// FEAT-0: AuthToken
model AuthToken {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  refreshToken String   @unique @map("refresh_token")
  deviceInfo   String?  @map("device_info")
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("auth_tokens")
}

// FEAT-1: Analysis
model Analysis {
  id          String   @id @default(uuid())
  userId      String?  @map("user_id")
  book        String
  chapter     Int
  verseStart  Int      @map("verse_start")
  verseEnd    Int      @map("verse_end")
  passageText String   @map("passage_text")
  status      String   @default("pending")
  rating      Int?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user        User?           @relation(fields: [userId], references: [id], onDelete: Cascade)
  result      AnalysisResult?
  meditations Meditation[]

  @@index([userId])
  @@index([status])
  @@index([book, chapter])
  @@map("analyses")
}

// FEAT-1: AnalysisResult (BibleWorks 스타일 파싱 포함)
model AnalysisResult {
  id               String   @id @default(uuid())
  analysisId       String   @unique @map("analysis_id")
  structure        Json
  explanation      String
  mainVerbs        Json     @map("main_verbs")
  modifiers        Json
  connectors       Json
  observation      Json?
  interpretation   Json?
  application      Json?
  theologicalReflection Json? @map("theological_reflection")
  prayerDedication      Json? @map("prayer_dedication")
  aiModel          String   @map("ai_model")
  processingTimeMs Int      @map("processing_time_ms")
  createdAt        DateTime @default(now()) @map("created_at")

  analysis     Analysis       @relation(fields: [analysisId], references: [id], onDelete: Cascade)
  verbAnalyses VerbAnalysis[]
  reviews      Review[]

  @@map("analysis_results")
}

// FEAT-2: VerbAnalysis (v2)
model VerbAnalysis {
  id               String   @id @default(uuid())
  analysisResultId String   @map("analysis_result_id")
  originalWord     String   @map("original_word")
  transliteration  String
  rootForm         String   @map("root_form")
  language         String
  tense            String?
  voice            String?
  mood             String?
  person           String?
  number           String?
  binyan           String?
  meaning          String
  position         Int
  createdAt        DateTime @default(now()) @map("created_at")

  analysisResult AnalysisResult @relation(fields: [analysisResultId], references: [id], onDelete: Cascade)

  @@index([analysisResultId])
  @@index([rootForm])
  @@index([language])
  @@map("verb_analyses")
}

// FEAT-3: Meditation (v2)
model Meditation {
  id              String   @id @default(uuid())
  userId          String?  @map("user_id")
  analysisId      String?  @map("analysis_id")
  content         String
  isAutoGenerated Boolean  @default(false) @map("is_auto_generated")
  status          String   @default("draft")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user     User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  analysis Analysis? @relation(fields: [analysisId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([analysisId])
  @@map("meditations")
}

// FEAT-1: Review
model Review {
  id               String   @id @default(uuid())
  analysisResultId String   @map("analysis_result_id")
  reviewerId       String   @map("reviewer_id")
  status           String
  comment          String?
  corrections      Json?
  createdAt        DateTime @default(now()) @map("created_at")

  analysisResult AnalysisResult @relation(fields: [analysisResultId], references: [id], onDelete: Cascade)
  reviewer       User           @relation(fields: [reviewerId], references: [id], onDelete: Cascade)

  @@index([analysisResultId])
  @@index([reviewerId])
  @@index([status])
  @@map("reviews")
}
